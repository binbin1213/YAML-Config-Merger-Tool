<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML Merger CLIé›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-title {
            color: #60a5fa;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            height: 200px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #e2e8f0;
            padding: 10px;
            font-family: inherit;
            resize: vertical;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            margin: 10px 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }
        .result {
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: inherit;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #065f46;
            color: #6ee7b7;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #ef4444;
        }
        .status.info {
            background: #1e3a8a;
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ YAML Merger CLI é›†æˆæµ‹è¯•</h1>

        <div class="test-section">
            <div class="test-title">ğŸ“¡ API çŠ¶æ€æ£€æŸ¥</div>
            <button onclick="checkApiStatus()">æ£€æŸ¥APIæœåŠ¡çŠ¶æ€</button>
            <div id="api-status"></div>
        </div>

        <div class="grid">
            <div class="test-section">
                <div class="test-title">ğŸ“„ æ¨¡æ¿é…ç½® (Template)</div>
                <textarea id="template" placeholder="åœ¨æ­¤è¾“å…¥æ¨¡æ¿YAML...">mixed-port: 7890
proxies:
  - name: direct
    type: direct
proxy-groups:
  - name: PROXY
    type: select
    proxies:
      - direct</textarea>
            </div>

            <div class="test-section">
                <div class="test-title">ğŸ‘¤ ç”¨æˆ·é…ç½® (User Config)</div>
                <textarea id="user" placeholder="åœ¨æ­¤è¾“å…¥ç”¨æˆ·YAML...">proxies:
  - name: test-proxy
    type: http
    server: example.com
    port: 8080</textarea>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">âš™ï¸ åˆå¹¶é€‰é¡¹</div>
            <label>
                <input type="checkbox" id="compatibility-mode"> å…¼å®¹æ¨¡å¼ (Compatibility Mode)
            </label>
            <br><br>
            <button onclick="testMerge()">ğŸ”— æµ‹è¯•åˆå¹¶</button>
            <button onclick="testValidate()" id="validate-btn">âœ… éªŒè¯YAML</button>
            <div id="merge-status"></div>
        </div>

        <div class="test-section">
            <div class="test-title">âœ¨ åˆå¹¶ç»“æœ (Merged Result)</div>
            <div id="result" class="result">åˆå¹¶ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦</div>
            <div id="summary" class="status info">
                å‡†å¤‡å¼€å§‹æµ‹è¯•...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.port === '3000' ? '/api' : 'http://localhost:8080/api';

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkApiStatus() {
            updateStatus('api-status', 'æ­£åœ¨æ£€æŸ¥APIçŠ¶æ€...', 'info');

            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('api-status', `âœ… APIæœåŠ¡æ­£å¸¸ - ç‰ˆæœ¬: ${data.version || 'unknown'}, çŠ¶æ€: ${data.status || 'ok'}`, 'success');
                } else {
                    updateStatus('api-status', `âŒ APIæœåŠ¡å¼‚å¸¸ - HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus('api-status', `âŒ æ— æ³•è¿æ¥åˆ°APIæœåŠ¡: ${error.message}`, 'error');
            }
        }

        async function testMerge() {
            const template = document.getElementById('template').value;
            const user = document.getElementById('user').value;
            const compatibilityMode = document.getElementById('compatibility-mode').checked;

            if (!template || !user) {
                updateStatus('merge-status', 'âŒ è¯·åŒæ—¶è¾“å…¥æ¨¡æ¿å’Œç”¨æˆ·é…ç½®', 'error');
                return;
            }

            updateStatus('merge-status', 'ğŸ”„ æ­£åœ¨è°ƒç”¨CLI APIè¿›è¡Œåˆå¹¶...', 'info');

            try {
                const response = await fetch(`${API_BASE}/merge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        template,
                        user,
                        options: {
                            compatibility_mode: compatibilityMode,
                            array_strategy: 'append',
                            keep_comments: true,
                            verbose: false
                        }
                    })
                });

                const data = await response.json();

                if (data.success && data.result) {
                    document.getElementById('result').textContent = data.result;
                    updateStatus('merge-status', `âœ… åˆå¹¶æˆåŠŸï¼ä½¿ç”¨äº†${compatibilityMode ? 'å…¼å®¹' : 'åŸç‰ˆ'}æ¨¡å¼`, 'success');
                    updateSummary('success', `âœ… CLIé›†æˆæµ‹è¯•æˆåŠŸ - ${compatibilityMode ? 'å…¼å®¹' : 'åŸç‰ˆ'}æ¨¡å¼`);
                } else {
                    updateStatus('merge-status', `âŒ åˆå¹¶å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    updateSummary('error', `âŒ CLIé›†æˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                updateStatus('merge-status', `âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                updateSummary('error', `âŒ CLIé›†æˆå¤±è´¥: ${error.message}`);
            }
        }

        async function testValidate() {
            const result = document.getElementById('result').textContent;

            if (!result || result === 'åˆå¹¶ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...') {
                updateStatus('merge-status', 'âŒ è¯·å…ˆè¿›è¡Œåˆå¹¶æ“ä½œ', 'error');
                return;
            }

            updateStatus('merge-status', 'ğŸ”„ æ­£åœ¨éªŒè¯åˆå¹¶ç»“æœ...', 'info');

            try {
                const response = await fetch(`${API_BASE}/validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: result
                    })
                });

                const data = await response.json();

                if (data.valid) {
                    updateStatus('merge-status', 'âœ… YAMLéªŒè¯é€šè¿‡ï¼', 'success');
                } else {
                    updateStatus('merge-status', `âŒ YAMLéªŒè¯å¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                updateStatus('merge-status', `âŒ éªŒè¯APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateSummary(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('summary').innerHTML = `
                <div class="status ${type}">
                    [${timestamp}] ${message}
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥APIçŠ¶æ€
        window.addEventListener('load', () => {
            checkApiStatus();
            updateSummary('info', 'ğŸ“‹ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹CLIé›†æˆéªŒè¯...');
        });
    </script>
</body>
</html>